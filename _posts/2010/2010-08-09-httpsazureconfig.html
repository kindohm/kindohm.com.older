---
layout: post
title: "HTTPS with Azure, Web APIs, Local Environments, and Build Automation"
---

<div><p>My, that&#8217;s a long title&#8230;.</p>  <p>On my current project we have developed a web-based API (e.g. sorta kinda RESTful) that allows remote applications to interface with our system. These remote applications currently include a Silverlight app and an iPhone app prototype.</p>  <p>Our web API is hosted at a secure HTTPS endpoint. This is crucial so that user credentials, which are required by our API, are not sent unencrypted across the internet. We could have chosen to require client applications to encrypt credentials before sending them to the API, but why not let SSL do that dirty work for you?</p>  <p>Our API is hosted in an Azure web role. When hosted at an HTTPS endpoint, the Azure web role must be configured for HTTPS and with the SSL certificate thumbprint before it is deployed to Windows Azure up in the cloud. This causes a problem for doing local development against the API when hosted in the Azure dev fabric: API calls will fail because the SSL certificate used does not match the localhost URL. When you browse a normal web site where the SSL certificate does not match the actual web site url, you get these certificate/identification warnings shown in browsers like Chrome and IE:</p>  <p><img src="/hodsmedia/927338768_1.png" alt=""/></p>  <p><img src="/hodsmedia/927338768_2.png" alt=""/></p>  <p>As a human, you can choose to bypass these warnings and let the web browser continue to render the site.  However, with a web-based API your code won&#8217;t let you make that choice. Your code will fail, and rightfully so. We wouldn&#8217;t want our automated API to use a web site that was potentially spoofing us.</p>  <p>If you compile and deploy your Azure cloud package through a TFS build (or another build system), this presents a problem. You need a local Cloud Service project with no SSL certificate (or a different SSL certificate) configured for your developers to develop on, but then you need to deploy a Cloud Service that <em>does</em> have the SSL certificate configuration.</p>  <p>There are a couple ways to handle this. The first approach is the one I recommend. The second one I don&#8217;t recommend, but it could be useful in certain contexts.</p>  <h3>1) Create Two Cloud Service Projects</h3>  <p>This is the approach I recommend. It requires less trickery with TFS build tasks/scripts and relies more on permanently storing the HTTPS/Certificate data in the cloud service projects themselves. It&#8217;s just easier.</p>  <p>Basically, just create two Cloud Service projects in your solution that host the same project for the web role:</p>  <p><img src="/hodsmedia/927338768_3.png" alt=""/></p>  <p>In one cloud service project, leave it with HTTP on port 80. With the second cloud project, add the HTTPS and Certificate configuration. You can do this by going to the Properties page for each web role in each cloud service project:</p>  <p><img src="/hodsmedia/927338768_4.png" alt=""/></p>  <p><img src="/hodsmedia/927338768_5.png" alt=""/></p>  <p>Now in your build/deploy automation you can just select which Cloud Service project and supporting files to use when calling cspack.exe. There. Done. Easy. Cake.</p>  <h3>2) Modify the Azure Service Definition and Config at Build Time</h3>  <p>At this time <em><strong>I do not recommend this approach</strong></em> as it just creates a lot of complexity in your build. I&#8217;m not even sure that this approach is worth writing about, but in some circumstances it may be appropriate. It&#8217;s also the first approach I tried in real life, and maybe after you read about it you can avoid the pain I went through.</p>  <p>The gist of this approach is to inject the HTTPS and SSL certificate configuration information into your Service Definition and Service Configuration files at build/deploy time. This will allow you to work with the Cloud Service package locally without HTTPS/SSL configuration, but deploy the package to Azure with the HTTPS/SSL configuration <em>without additional Azure Cloud Service projects</em>.</p>  <p>You&#8217;ll need to create custom tasks or scripts that will run during your build to make copies of the ServiceDefinition.csdef and ServiceConfiguration.cscfg files. You can even use new names for them. You&#8217;ll modify these new copies to include the HTTPS/SSL configuration. Point to your new copies when you run cspack.exe to create your cloud package.</p>  <p>In short, you&#8217;ll need to modify your ServiceDefinition.csdef file from this:</p>  <script src="http://gist.github.com/515404.js?file=gistfile1.xml"></script><p>To this:</p>  <script src="http://gist.github.com/515405.js?file=gistfile1.xml"></script><p>And modify your ServiceConfiguration.cscfg file from this:</p>  <script src="http://gist.github.com/515410.js?file=gistfile1.xml"></script><p>To this (adding the Certificates element):</p>  <script src="http://gist.github.com/515413.js?file=gistfile1.xml"></script><p>Obviously - use your own role and certificate names as well as your own real SSL thumbprint.</p>  <p>I recommend getting comfortable with these config settings and being able to read the XML before you start manipulating the files in a build task. You can warm up to the idea by manipulating these settings in the Properties of your Azure web role in Visual Studio. Visual Studio will modify your ServiceDefinition.csdef and ServiceConfiguration.cscfg files when you change these properties in Visual Studio:</p>  <p><img src="/hodsmedia/927338768_4.png" alt=""/></p>  <p>Again, just use Visual Studio in a test project to warm up to the idea - you don&#8217;t want to embed the real SSL/HTTPS configuration into your local environment with this approach.</p>  <p>After you add custom scripts or tasks in your build to create the new Service Definition and Service Configuration, you can call cspack.exe, point to the right files, and generate an Azure package with the SSL/HTTPS configuration that you need.</p></div>     
