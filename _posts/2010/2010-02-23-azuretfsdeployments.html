---
layout: post
title: "Automated Azure Deployments with TFS Build"
---

<div><p>I recently had the <span style="text-decoration: line-through;">pain</span> pleasure of setting up automatic Azure deployments as part of our TFS build process for an ASP.NET MVC app. There is a fair amount of documentation out there already on the tasks required to get this working, but you have to connect a few dots and correct a few problems along the way.</p>  <p>First read Dominic Green&#8217;s post on the topic: <a href="http://blogs.msdn.com/domgreen/archive/2009/09/29/deploying-to-the-cloud-as-part-of-your-daily-build.aspx" target="_blank"><a href="http://blogs.msdn.com/domgreen/archive/2009/09/29/deploying-to-the-cloud-as-part-of-your-daily-build.aspx" target="_blank">http://blogs.msdn.com/domgreen/archive/2009/09/29/deploying-to-the-cloud-as-part-of-your-daily-build.aspx</a></a>. For the most part, his post covers about 90% of what you need to know.</p>  <p>One &#8220;gotcha&#8221; is with certificates and the TFS build server. You will need to create a certificate <em><strong><em><strong>on the build machine</strong></em></strong></em> and upload it to Azure management API certificate area. However you will likely run into an &#8220;Anonymous&#8221; scheme error and will need to follow the guidelines that Alexander Strauss lays out in his post <a href="http://blogs.msdn.com/astrauss/archive/2010/01/28/tales-about-working-with-the-azure-service-management-api-chapter-i.aspx" target="_blank"><a href="http://blogs.msdn.com/astrauss/archive/2010/01/28/tales-about-working-with-the-azure-service-management-api-chapter-i.aspx" target="_blank">http://blogs.msdn.com/astrauss/archive/2010/01/28/tales-about-working-with-the-azure-service-management-api-chapter-i.aspx</a></a>:</p>  <div style="margin-left: 30px;margin-right: 30px;font-style: italic;"> <p>&#8230;in my first try I run into an error that I was not able to get my Service Management API requests authenticated. The service always returned:</p>  <p>Error 403 (Forbidden): The HTTP request was forbidden with client authentication scheme &#8216;Anonymous&#8217;.</p>  <p>In order to have the requests working you need to meet two prerequisites for your certificate:</p>     <ol><li>The certificate needs to be installed in the certificate store of the client machine from where you send the requests to the Service Management API.</li>    <li>The certificate must have an associated private key.</li>   </ol></div>  <p>Certificates in Windows are kind of magical to me and I&#8217;m glad there are folks out there who have already dug in to that stuff.</p>  <p>Last, you will need to modify the source code of the csmanage.exe tool referenced by Dominic. You can get the csmanage.exe tool here: <a href="http://code.msdn.microsoft.com/Wiki/View.aspx?ProjectName=windowsazuresamples" target="_blank"><a href="http://code.msdn.microsoft.com/Wiki/View.aspx?ProjectName=windowsazuresamples" target="_blank">http://code.msdn.microsoft.com/Wiki/View.aspx?ProjectName=windowsazuresamples</a></a>. The problem with csmanage.exe at the time of this writing is that it incorrectly returns an exit code of &#8220;1&#8221; when the operations run successfully and an exit code of &#8220;0&#8221; when there are errors. In the Main() method of csmanage.exe you can find this code:</p>  <script src="http://gist.github.com/312531.js?file=mgr.cs"></script><p>The problem is that Program.ExecuteActions() returns a bool that represents a &#8220;hasErrors&#8221; value internally. Thus, if &#8220;hasErrors&#8221; is false, then the program should return &#8220;0&#8221;. You can simply modify the source code and change the condition to deal with this:</p>  <script src="http://gist.github.com/312534.js?file=mgr2.cs"></script><p>Happy deploying!</p></div>     
